#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <inttypes.h>
#include <stdbool.h>

#include <string.h>
#include <byteswap.h>

#include "keccak.h"

int getCreate2Address(uint8_t *address, uint8_t *salt, uint8_t *bytecodeHash, uint8_t *outAddress)
{
  uint8_t buffer[1 + 20 + 32 + 32];
  uint8_t hash[32];

  buffer[0] = 0xff;
  memcpy(buffer + 1, address, 20);
  memcpy(buffer + 21, salt, 32);
  memcpy(buffer + 53, bytecodeHash, 32);

  int res = sha3_256((uint8_t *)buffer, sizeof(buffer), hash);
  if (res != 0)
  {
    fprintf(stderr, "SHA3 failed with %d\n", res);
    return res;
  }

  for (int i = 0; i < 20; ++i)
  {
    outAddress[i] = hash[i + 12];
  }

  return 0;
}

void incrementSalt(uint8_t *salt)
{
  for (int i = 31; i >= 0; --i)
  {
    salt[i] += 1;
    if (salt[i] != 0)
    {
      break;
    }
  }
}

void printAddress(uint8_t *address)
{
  for (int i = 0; i < 20; ++i)
  {
    printf("%02x", address[i]);
  }
  printf("\n");
}

void printSalt(uint8_t *salt)
{
  for (int i = 0; i < 32; ++i)
  {
    printf("%02x", salt[i]);
  }
  printf("\n");
}

bool isPatternMatch(uint8_t *address, uint8_t *pattern, int patternLength)
{
  for (int i = 0; i < patternLength; ++i)
  {
    if (address[i] != pattern[i])
    {
      return false;
    }
  }
  return true;
}

int main()
{
  uint8_t addressFrom[20] = {
      243, 159, 214, 229, 26, 173, 136, 246, 244, 206, 106, 184, 130, 114, 121, 207, 255, 185, 34, 102};
  uint8_t salt[32] = {0};
  uint8_t bytecode[] = {
      96, 128, 96, 64, 82, 52, 128, 21, 97, 0, 16, 87, 96, 0, 128, 253, 91, 80, 97, 4, 51, 128, 97, 0, 32, 96, 0, 57, 96, 0, 243, 254, 96, 128, 96, 64, 82, 96, 4, 54, 16, 97, 0, 41, 87, 96, 0, 53, 96, 224, 28, 128, 99, 58, 75, 102, 241, 20, 97, 0, 46, 87, 128, 99, 210, 7, 96, 77, 20, 97, 0, 56, 87, 91, 96, 0, 128, 253, 91, 97, 0, 54, 97, 0, 75, 86, 91, 0, 91, 97, 0, 54, 97, 0, 70, 54, 96, 4, 97, 2, 103, 86, 91, 97, 0, 114, 86, 91, 96, 2, 84, 21, 97, 0, 112, 87, 96, 2, 128, 84, 144, 96, 0, 97, 0, 99, 131, 97, 2, 185, 86, 91, 145, 144, 80, 85, 80, 97, 0, 112, 97, 0, 180, 86, 91, 86, 91, 96, 0, 128, 84, 96, 1, 96, 1, 96, 160, 27, 3, 128, 134, 22, 96, 1, 96, 1, 96, 160, 27, 3, 25, 146, 131, 22, 23, 144, 146, 85, 96, 1, 128, 84, 146, 133, 22, 146, 144, 145, 22, 145, 144, 145, 23, 144, 85, 96, 2, 129, 144, 85, 97, 0, 175, 97, 0, 180, 86, 91, 80, 80, 80, 86, 91, 96, 64, 128, 81, 96, 1, 128, 130, 82, 129, 131, 1, 144, 146, 82, 96, 0, 145, 96, 32, 128, 131, 1, 144, 128, 54, 131, 55, 80, 80, 96, 1, 84, 130, 81, 146, 147, 80, 96, 1, 96, 1, 96, 160, 27, 3, 22, 145, 131, 145, 80, 96, 0, 144, 97, 0, 246, 87, 97, 0, 246, 97, 2, 208, 86, 91, 96, 1, 96, 1, 96, 160, 27, 3, 146, 144, 146, 22, 96, 32, 146, 131, 2, 145, 144, 145, 1, 144, 145, 1, 82, 96, 64, 128, 81, 96, 1, 128, 130, 82, 129, 131, 1, 144, 146, 82, 96, 0, 145, 129, 96, 32, 1, 91, 96, 96, 129, 82, 96, 32, 1, 144, 96, 1, 144, 3, 144, 129, 97, 1, 38, 87, 144, 80, 80, 144, 80, 97, 1, 72, 66, 96, 1, 97, 2, 230, 86, 91, 96, 64, 128, 81, 96, 32, 129, 1, 146, 144, 146, 82, 111, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 48, 22, 144, 130, 1, 82, 96, 96, 1, 96, 64, 81, 96, 32, 129, 131, 3, 3, 129, 82, 144, 96, 64, 82, 129, 96, 0, 129, 81, 129, 16, 97, 1, 144, 87, 97, 1, 144, 97, 2, 208, 86, 91, 96, 32, 144, 129, 2, 145, 144, 145, 1, 1, 82, 96, 64, 128, 81, 96, 1, 128, 130, 82, 129, 131, 1, 144, 146, 82, 96, 0, 145, 129, 96, 32, 1, 96, 32, 130, 2, 128, 54, 131, 55, 1, 144, 80, 80, 144, 80, 52, 129, 96, 0, 129, 81, 129, 16, 97, 1, 211, 87, 97, 1, 211, 97, 2, 208, 86, 91, 96, 32, 144, 129, 2, 145, 144, 145, 1, 1, 82, 96, 0, 84, 96, 64, 81, 99, 19, 190, 44, 99, 96, 225, 27, 129, 82, 96, 1, 96, 1, 96, 160, 27, 3, 144, 145, 22, 144, 99, 39, 124, 88, 198, 144, 52, 144, 97, 2, 20, 144, 135, 144, 135, 144, 135, 144, 96, 4, 1, 97, 3, 57, 86, 91, 96, 0, 96, 64, 81, 128, 131, 3, 129, 133, 136, 128, 59, 21, 128, 21, 97, 2, 45, 87, 96, 0, 128, 253, 91, 80, 90, 241, 21, 128, 21, 97, 2, 65, 87, 61, 96, 0, 128, 62, 61, 96, 0, 253, 91, 80, 80, 80, 80, 80, 80, 80, 80, 86, 91, 128, 53, 96, 1, 96, 1, 96, 160, 27, 3, 129, 22, 129, 20, 97, 2, 98, 87, 96, 0, 128, 253, 91, 145, 144, 80, 86, 91, 96, 0, 128, 96, 0, 96, 96, 132, 134, 3, 18, 21, 97, 2, 124, 87, 96, 0, 128, 253, 91, 97, 2, 133, 132, 97, 2, 75, 86, 91, 146, 80, 97, 2, 147, 96, 32, 133, 1, 97, 2, 75, 86, 91, 145, 80, 96, 64, 132, 1, 53, 144, 80, 146, 80, 146, 80, 146, 86, 91, 99, 78, 72, 123, 113, 96, 224, 27, 96, 0, 82, 96, 17, 96, 4, 82, 96, 36, 96, 0, 253, 91, 96, 0, 129, 97, 2, 200, 87, 97, 2, 200, 97, 2, 163, 86, 91, 80, 96, 0, 25, 1, 144, 86, 91, 99, 78, 72, 123, 113, 96, 224, 27, 96, 0, 82, 96, 50, 96, 4, 82, 96, 36, 96, 0, 253, 91, 96, 0, 130, 25, 130, 17, 21, 97, 2, 249, 87, 97, 2, 249, 97, 2, 163, 86, 91, 80, 1, 144, 86, 91, 96, 0, 129, 81, 128, 132, 82, 96, 32, 128, 133, 1, 148, 80, 128, 132, 1, 96, 0, 91, 131, 129, 16, 21, 97, 3, 46, 87, 129, 81, 135, 82, 149, 130, 1, 149, 144, 130, 1, 144, 96, 1, 1, 97, 3, 18, 86, 91, 80, 148, 149, 148, 80, 80, 80, 80, 80, 86, 91, 96, 96, 128, 130, 82, 132, 81, 144, 130, 1, 129, 144, 82, 96, 0, 144, 96, 32, 144, 96, 128, 132, 1, 144, 130, 136, 1, 132, 91, 130, 129, 16, 21, 97, 3, 123, 87, 129, 81, 96, 1, 96, 1, 96, 160, 27, 3, 22, 132, 82, 146, 132, 1, 146, 144, 132, 1, 144, 96, 1, 1, 97, 3, 86, 86, 91, 80, 80, 80, 131, 129, 3, 130, 133, 1, 82, 133, 81, 128, 130, 82, 130, 130, 1, 144, 96, 5, 129, 144, 27, 131, 1, 132, 1, 136, 133, 1, 96, 0, 91, 131, 129, 16, 21, 97, 4, 4, 87, 96, 31, 25, 128, 135, 133, 3, 1, 134, 82, 130, 81, 128, 81, 128, 134, 82, 96, 0, 91, 129, 129, 16, 21, 97, 3, 212, 87, 130, 129, 1, 139, 1, 81, 135, 130, 1, 140, 1, 82, 138, 1, 97, 3, 185, 86, 91, 129, 129, 17, 21, 97, 3, 229, 87, 96, 0, 139, 131, 137, 1, 1, 82, 91, 80, 150, 137, 1, 150, 96, 31, 1, 144, 145, 22, 147, 144, 147, 1, 135, 1, 146, 80, 144, 134, 1, 144, 96, 1, 1, 97, 3, 157, 86, 91, 80, 80, 134, 129, 3, 96, 64, 136, 1, 82, 97, 4, 24, 129, 137, 97, 2, 254, 86, 91, 154, 153, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 86, 254, 161, 100, 115, 111, 108, 99, 67, 0, 8, 9, 0, 10};
  uint8_t bytecodeHash[32] = {};

  int res = sha3_256((uint8_t *)bytecode, sizeof(bytecode), bytecodeHash);
  if (res != 0)
  {
    fprintf(stderr, "SHA3 failed with %d\n", res);
    return -1;
  }

  uint8_t pattern[] = {0x00, 0x00, 0x00, 0x00};
  uint8_t address[20];

  uint64_t count = 4527000000;
  uint64_t countLE = bswap_64(count);
  memcpy(salt + 24, (uint8_t *)&countLE, sizeof(uint64_t));
  printSalt(salt);

  while (true)
  {
    res = getCreate2Address(addressFrom, salt, bytecodeHash, address);

    // printAddress(address);

    if (isPatternMatch(address, pattern, sizeof(pattern)))
    {
      break;
    }

    if (++count % 1000000 == 0)
    {
      printf("%lu\n", count);
    }

    incrementSalt(salt);
  }

  printAddress(address);
  printSalt(salt);

  return 0;
}
